用Last[value]表示数值value最近出现的位置，一开始全部赋为0，用ST[I]第i个数为结尾的最长完美序列的起始位置，ST的计算可以用以下递推式得到ST[I]=MAX(ST[I-1],Last[A[I]]+1)，用F[I]表示第I个数为结尾的最长完美序列的长度，很显然 F[I]=I-ST[I]+1，ST[I]和F[I]都可以在O(N)内计算出来。
由ST的递推式可知，ST的值是一个非递减的序列，那么对于一个询问区间[Li,Ri]，该区间内的ST值可能会出现：左边一部分的ST值不在区间内即小于Li，而右边一部分的ST值大于等于Li,由于ST 值具有单调性，所以这个分界点可以通过二分得到，假设该位置求出来为Mi,即ST[Li..Mi-1]<Li,而ST[Mi..Ri]>=Li，那么整个区间[Li,Ri]的最长AC序列的长度，分为两部分来求，其中左边部分的最大值很显然为Mi-Li，而右边一部分由于ST值大于等于Li,所以就是求[Mi,Ri]内F的最大值，可以用RMQ的方法来求，所以整个问题的时间复杂度为O((M+N)*lgN)，分别是RMQ预处理的时间+询问二分的时间。